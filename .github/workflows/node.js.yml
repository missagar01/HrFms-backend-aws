name: Deploy HRFMS Backend (EC2 Self-Hosted)

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: false   # workspace wipe kam hota hai, but env still external keep

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build (if any)
        run: npm run build --if-present

      - name: Restore .env (DO NOT commit .env)
        run: |
          cp /home/ubuntu/secrets/hrfms-backend/.env ./.env
          chmod 600 ./.env

      - name: Fix server entry require
        run: |
          sed -i "s|require('./app')|require('./src/app')|g" server.js || true

      - name: Restart PM2
        run: |
          pm2 start server.js --name hrfms-backend --time || true
          pm2 restart hrfms-backend
          pm2 save

      - name: Health check
        run: |
          PORT=$(grep -E '^PORT=' .env | cut -d= -f2 | tr -d '\r' || true)
          if [ -z "$PORT" ]; then PORT=3000; fi
          curl -f "http://localhost:${PORT}/health"
